# 项目逻辑更改计划

整体的项目逻辑需要进行大改，改成下面的逻辑功能：

## 低层事件感知：收集 raw_record

- 截屏：默认 1s 一张（参数可修改）
- 鼠标、键盘：实时监听

其中截屏要进行去重，如果是两张连续的图片，后面一张和前面一张一模一样，就舍弃后面那张

此时这些 raw_record 都存在内存里面，并没有进行持久化存储

## 中层事件提取：把 raw_records 提取成 event

默认每积累 20 张（参数可修改）屏幕截图之后，会把这段时间内的所有records这样处理：

给LLM API的message这样构造：

    """
    你是用户屏幕截图的分析专家。你能够感知到用户的屏幕截图和鼠标键盘的操作。你负责深度理解用户的桌面截图内容，生成全面详尽的自然语言描述，并与历史上下文融合。
    ## 核心原则
    - 深度理解：不仅识别可见内容，更要理解行为意图和上下文含义
    - 自然描述：用自然语言描述"在做什么"，而非简单摘录文本
    - 行为推理：基于界面状态推理用户的具体行为和目标
    - 全面提取：最大化地提取和保留截图中所有有价值的信息
    - 知识保存：确保生成的内容可作为高质量的记忆上下文
    ## 输入
    这是感知到的用户最近20张屏幕截图信息：
    (20张屏幕截图)
    这是这段时间里面用户鼠标键盘的使用情况：
    用户有/没有在使用鼠标/键盘
    ## 处理流程
    ### 第一阶段：整体理解
    - **全局认知**：阅读截图，形成完整认知
        - 识别所有可见的文字内容、数值、选项、按钮、状态信息
        - 理解界面布局、用户当前操作位置、交互状态
        - 分析内容的技术层次和专业程度
    - **事件识别**：判断截图中包含几个不同的事件
        - 识别用户进行了哪些独立的事件
        - 理解用户的活动轨迹，形成连贯的行为序列
    - **行为推理**：基于界面状态推理具体的行为和意图
    ### 第二阶段：总结生成 event
    5. **生成事件上下文**：每个独立事件必须生成一个 event_description
        - 不同主题的事件分别生成独立的 event
        - 如果用户同时进行多个不同主题的事件，必须生成多个独立的 event 项

    6. **具体内容提取**：**重点环节** - 详细提取截图中的具体信息
        - **技术内容**: 提取代码片段、命令语法、参数值、配置选项
        - **数据信息**: 记录具体数值、统计信息、列表项目、状态值
        - **操作细节**: 描述具体的点击位置、输入内容、选择项目
        - **文档内容**: 摘录关键知识点、概念定义、示例说明
        - **界面元素**: 记录窗口标题、菜单选项、按钮文字、提示信息
        - **聊天互动**: 记录对话内容和发言人、问题答案、交互反馈
        - **日程管理**: 记录会议时间、地点、参与人员、议程项目
    ### 第三阶段：补充信息生成
    除了提取出来用户的event信息，你还需要帮助用户整理用户感知到的信息，而不仅仅是用户“在做什么”，还需要有“学到了什么”、“需要做什么”
    - 知识内容：
        * **识别线索**：产品介绍页面、技术文档、教程内容、架构说明、配置规范、概念定义
        * **提取要求**：从截图中提取可独立存在的知识内容，只记录知识本身，不描述用户操作
    - TODO：
        * **识别线索**：待办列表、日历、计划文档、聊天记录、未开始的任务
        * **提取要求**：提取明确的未来计划和目标
    ## 输出格式
    充分思考，然后输出下面的JSON对象，JSON部分无解释文字：
    ```json
    {{
    "events": [
        {{
        "title": "string",
        "description": "string",
        "keywords": ["string"]
        }}
    ],
    "knowledge": [
        {{
        "title": "string",
        "description": "string",
        "keywords": ["string"]
        }}
    ],
    "todos": [
        {{
        "title": "string",
        "description": "string",
        "keywords": ["string"]
        }}
    ],
    }}
    ```
    """

经过上面的步骤，解析得到：

```json
{{
"events": [
    {{
    "title": "string",
    "description": "string",
    "keywords": ["string"],
    }}
],
"knowledge": [
    {{
    "title": "string",
    "description": "string",
    "keywords": ["string"]
    }}
],
"todos": [
    {{
    "title": "string",
    "description": "string",
    "keywords": ["string"]
    }}
],
}}
```

这样的 json 数据，把这三类数据可以保存在db中。

## 高层活动总结：把 events 总结成 activity

默认每隔 10 min （参数可修改）总结一次 events 信息
给LLM API的message这样构造：

    """
    你是一个专业的用户信息分析专家。你的任务是根据一段时间内用户的events，来把语义相似的事件聚合成activity，做一个更高层的抽象总结。
    ## 核心原则
    - 仔细分析分割或合并
    必须明确是同一件事才能合并，否则保持独立。合并条件非常严格：
        * 应该合并: "正在编写登录功能代码"和"继续编写登录功能代码" - 明确是同一个具体任务的延续
        * 应该合并: "在IDE中调试bug"和"继续在IDE中调试同一个bug" - 明确是同一问题的持续处理
        * 不应合并: "配置工具凭证"和"编辑配置文件" - 虽然相关但是两个独立操作
        * 不应合并: "查看成功日志"和"处理错误信息" - 结果状态不同的活动
        * 不应合并: "在终端执行命令"和"在聊天中讨论问题" - 不同环境的不同活动
    - 保留全部描述,不要概括
    合并时必须保留所有原始信息的细节,不能简化或省略。合并后的description应该是所有相关信息的完整整合
    ## 输入内容
    下面是这段时间内所有 event 的详细信息
    [
        {
            "index": 1,
            "title": "xxx", 
            "description": "xxx"
        },
        {
            "index": 2,
            "title": "xxx", 
            "description": "xxx"
        },
        ...
    ]
    ## 输出格式
    充分思考，然后输出下面的JSON对象，JSON部分无解释文字：
    ```json
    {{
        "activities": [
            {{
                "title": string (title of activity),
                "description": string (detailed, complete description of this abstracted activity),
                "source": List[string] (indexs of events which belong to this activity)
            }},
            ...
        ]
    }}
    ```
    """

## 日记总结

把选定日期的所有 acitivity 总结成一个日记，生成的文本如果用到了activity要加上对应的引用。

## 高层knowledge/todo合并

默认每隔 20 min （参数可修改）总结一次 knowledge/todo 信息，总结成combined_knowledge和combined_todo，对于相关的 knowledge/todo 聚合在一起互为补充,也要有title, description, keywords, merged_from_ids字段

## 前端显示逻辑

侧边栏加一个 “最近事件”，显示最近 n（默认为5，可在前端和配置中修改）条events
侧边栏加一个 “AI总结”，里面有几个子栏目
    - 知识总结：显示所有的knowledge，支持删除
    - TODO List：显示所有的todo，支持删除
    - 日记：显示“日记总结”部分的功能，支持删除

## prompt config

prompt的配置应该分中英文两份文件，当系统语言选英文的时候用英文的prompt，当系统语言选中文的时候用中文的prompt